FROM alpine:3.14 as builder

ARG version=3.1

RUN apk update && apk add \
  `# install tools` \
  git g++ gcc gdb make cmake py3-pytest python3 valgrind \
  `# install clamav dependencies` \
  glib2-dev icu-dev curl-dev ragel-dev libluajit-dev \
  sqlite3-dev libmagic hyperscan-dev \
  linux-headers openssl-dev pcre2-dev zlib-dev

WORKDIR /rspamd

RUN git clone --recursive --depth 1 --branch ${version} https://github.com/rspamd/rspamd.git ./

RUN cmake . \
    -D ENABLE_HYPERSCAN=ON \
    -D ENABLE_LUAJIT=ON \
    -D CMAKE_BUILD_TYPE=RelWithDebuginfo
RUN cmake --build .
RUN ctest
RUN sudo cmake --build . --target install -- DESTDIR="/rspamd_temp"


FROM alpine:3.14 as app

COPY --from=builder /rspamd_temp /

RUN apk update && apk add --no-cache tini

ENTRYPOINT ["tini", "--", "/bin/sh", "-c"]
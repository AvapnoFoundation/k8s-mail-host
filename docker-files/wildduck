FROM node:12-alpine3.14 as builder

ARG version

RUN apk add --no-cache git python3 make g++

WORKDIR /wildduck

RUN git clone --recursive --depth 1 --branch v${version} https://github.com/nodemailer/wildduck.git ./
RUN npm install --production


FROM node:12-alpine3.14 as app

RUN addgroup -S k8s-mail-host && adduser -S k8s-mail-host -G k8s-mail-host
USER k8s-mail-host

ENV NODE_ENV production

RUN apk add --no-cache tini

WORKDIR /wildduck
COPY --from=builder /wildduck /wildduck

ENTRYPOINT ["tini", "--", "node", "server.js"]
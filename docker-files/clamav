FROM alpine:3.14 as builder

ARG version=0.104.1

RUN apk update && apk add \
  `# install tools` \
  git g++ gcc gdb make cmake py3-pytest python3 valgrind \
  `# install clamav dependencies` \
  bzip2-dev check-dev curl-dev json-c-dev libmilter-dev libxml2-dev \
  linux-headers ncurses-dev openssl-dev pcre2-dev zlib-dev

WORKDIR /clamav

RUN git clone --recursive --depth 1 --branch clamav-${version} https://github.com/Cisco-Talos/clamav.git ./

RUN mkdir build; \
    cd build; \
    cmake .. \
      -D CMAKE_INSTALL_PREFIX=/usr \
      -D CMAKE_INSTALL_LIBDIR=lib \
      -D APP_CONFIG_DIRECTORY=/etc/clamav \
      -D DATABASE_DIRECTORY=/var/lib/clamav \
      -D ENABLE_JSON_SHARED=ON; \
    cmake --build .; \
    ctest; \
    cmake --build . --target install -- DESTDIR="/clamav_temp"


FROM alpine:3.14 as app

COPY --from=builder /clamav_temp /

RUN apk update && apk add --no-cache tini

ENTRYPOINT ["tini", "--", "/bin/sh", "-c"]